name: Test Datastream Options Forcings Sources

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - '.github/workflows/test_datastream_options_forcings_sources.yaml'
      - 'scripts/datastream'
      - 'versions.yml'
  pull_request:
    branches: [main]
    paths:
      - '.github/workflows/test_datastream_options_forcings_sources.yaml'
      - 'scripts/datastream'
      - 'versions.yml'

permissions:
  contents: read

jobs:
  test-datastream-options-forcings-sources:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      - name: Configure AWS
        run: |
          aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws configure set region us-east-1

      - name: Build docker containers
        run: docker compose -f docker/docker-compose.yml build datastream

      - name: Setup and run forcings tests
        run: |
          cat > run_forcings_tests.sh << 'SCRIPT'
          #!/bin/bash
          set -e
          
          WS="${{ github.workspace }}"
          GPKG="palisade.gpkg"
          REALIZATION="$WS/configs/ngen/realization_sloth_nom_cfe_pet.json"
          
          # Download geopackage
          echo "=== Downloading geopackage ==="
          curl -L -O https://ngen-datastream.s3.us-east-2.amazonaws.com/$GPKG
          
          # Test 1: Base test with NWM_RETRO_V3
          echo "=== Test 1: Base test NWM_RETRO_V3 ==="
          rm -rf "$WS/data/datastream_test"
          ./scripts/datastream -s 202006200100 -e 202006200200 -C NWM_RETRO_V3 -d "$WS/data/datastream_test" -g "$WS/$GPKG" -R "$REALIZATION"
          
          # Cache resources
          echo "=== Caching resources ==="
          mkdir -p ./data/cache
          cp ./data/datastream_test/datastream-metadata/datastream.env ./data/cache
          cp -r "$WS/data/datastream_test/datastream-resources" ./data/cache
          cp -r "$WS/data/cache/datastream-resources" ./data/cache/datastream-resources-no-forcings
          rm -rf ./data/cache/datastream-resources-no-forcings/ngen-forcings
          
          # Test 2: NWM_RETRO_V2
          echo "=== Test 2: Forcings sources NWM_RETRO_V2 ==="
          rm -rf "$WS/data/datastream_test"
          ./scripts/datastream -r ./data/cache/datastream-resources-no-forcings -s 201906200100 -e 201906200200 -C NWM_RETRO_V2 -d "$WS/data/datastream_test"
          
          # Test 3: NOMADS
          echo "=== Test 3: Forcings sources NOMADS ==="
          rm -rf "$WS/data/datastream_test"
          TODAY=$(TZ=US/Eastern date +'%Y%m%d')
          ./scripts/datastream -r ./data/cache/datastream-resources-no-forcings -s "${TODAY}0100" -e "${TODAY}0200" -C NOMADS -d "$WS/data/datastream_test"
          
          # Test 4: DAILY short_range 00 today
          echo "=== Test 4: DAILY short_range 00 today ==="
          rm -rf "$WS/data/datastream_test"
          ./scripts/datastream -s DAILY -C NWM_SHORT_RANGE_00 -d "$WS/data/datastream_test" -g "$WS/$GPKG" -R "$REALIZATION"
          
          # Test 5: DAILY short_range 23 today
          echo "=== Test 5: DAILY short_range 23 today ==="
          rm -rf "$WS/data/datastream_test"
          ./scripts/datastream -s DAILY -C NWM_SHORT_RANGE_23 -d "$WS/data/datastream_test" -g "$WS/$GPKG" -R "$REALIZATION"
          
          # Test 6: DAILY short_range 00 pick day
          echo "=== Test 6: DAILY short_range 00 pick day ==="
          rm -rf "$WS/data/datastream_test"
          PICK_DAY=$(date -d '-15 day' '+%Y%m%d0000')
          ./scripts/datastream -s DAILY -e "$PICK_DAY" -C NWM_SHORT_RANGE_00 -d "$WS/data/datastream_test" -g "$WS/$GPKG" -R "$REALIZATION"
          
          # Test 7: DAILY medium_range 00 0
          echo "=== Test 7: DAILY medium_range 00 0 ==="
          rm -rf "$WS/data/datastream_test"
          ./scripts/datastream -s DAILY -C NWM_MEDIUM_RANGE_00_0 -d "$WS/data/datastream_test" -g "$WS/$GPKG" -R "$REALIZATION"
          
          # Test 8: DAILY medium_range 00 3
          echo "=== Test 8: DAILY medium_range 00 3 ==="
          rm -rf "$WS/data/datastream_test"
          YESTERDAY=$(date -d '-1 day' '+%Y%m%d')
          ./scripts/datastream -s DAILY -e "${YESTERDAY}0000" -n 1 \
            -F "s3://ciroh-community-ngen-datastream/forcings/v2.2_hydrofabric/ngen.$YESTERDAY/forcing_medium_range/18/ngen.t18z.medium_range.forcing.f001_f240.VPU_09.nc" \
            --FORCING_SOURCE NWM_V3_MEDIUM_RANGE_06_3 \
            -d "$WS/data/datastream_test" \
            -r s3://ciroh-community-ngen-datastream/resources/v2.2_hydrofabric/datastream-resources/VPU_09 \
            -R https://ciroh-community-ngen-datastream.s3.us-east-1.amazonaws.com/realizations/realization_VPU_09.json
          
          # Test 9: DAILY analysis assim extend
          echo "=== Test 9: DAILY analysis assim extend ==="
          rm -rf "$WS/data/datastream_test"
          TWO_DAYS_AGO=$(date -d '-2 day' '+%Y%m%d0000')
          ./scripts/datastream -s DAILY -C NWM_ANALYSIS_ASSIM_EXTEND_16 -e "$TWO_DAYS_AGO" -d "$WS/data/datastream_test" -g "$WS/$GPKG" -R "$REALIZATION"
          
          echo "=== All forcings tests passed ==="
          SCRIPT
          
          chmod +x run_forcings_tests.sh
          ./run_forcings_tests.sh